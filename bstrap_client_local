#!/bin/bash

CHEF_ROLE=$1

# install ruby and other pre-requisites
apt-get install -y ruby ruby1.8-dev libopenssl-ruby1.8 rdoc ri irb build-essential wget ssl-cert

# install rubygems
wget http://p.evitelabs.com/download/rubygems-1.3.7.tgz
tar xvfz rubygems-1.3.7.tgz
cd rubygems-1.3.7
ruby setup.rb
ln -sfv /usr/bin/gem1.8 /usr/bin/gem

# install chef via gem
gem install chef --no-rdoc --no-ri

# download chef scripts and configuration files
# note that CHEF_ROLE dictates with JSON file to use (associates client with that role)
mkdir -p /etc/chef
wget -qO/etc/chef/client.rb http://github.com/ijonas/my-chef-scripts/raw/master/client.rb
wget -qO/etc/chef/chef.json http://github.com/ijonas/my-chef-scripts/raw/master/chef.${CHEF_ROLE}.json
wget -qO/etc/init.d/chef-client http://gist.github.com/raw/484780/ac3753ed0f75631e56b638c5ee343967a555edf2/gistfile1.txt

# initial run of chef -- role association happens
chef-client -j /etc/chef/chef.json -L /var/log/chef.log -l debug

# remove validation key
rm -rf /etc/chef/validation.pem

# run init script and chkconfig it on
chmod +x /etc/init.d/chef-client
chkconfig chef-client on
/etc/init.d/chef-client start
